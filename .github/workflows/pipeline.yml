name: CI/CD Pipeline

on:
  push:
    branches:
      - main


permissions:
  packages: write
  contents: read


jobs:
  build-and-push:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push Docker image
        uses: docker/build-push-action@v6
        with:
          context: .
          push: true
          tags: |
            ghcr.io/marwaneahansal/nextjs-pipeline:latest
            ghcr.io/marwaneahansal/nextjs-pipeline:${{ github.sha }}

  deploy:
    runs-on: ubuntu-latest
    needs:
      - build-and-push
    steps:
    - name: Checkout code
      uses: actions/checkout@v2

    - name: Setup SSH key
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.DEPLOY_SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa
        ssh-keyscan -H ${{ secrets.HOST }} >> ~/.ssh/known_hosts

    - name: Test SSH connection
      run: |
        ssh -i ~/.ssh/id_rsa ${{ secrets.USER }}@${{ secrets.HOST }} "echo 'SSH connection successful'"

    - name: Create env file
      run: |
        echo "GIT_COMMIT_HASH=${{ github.sha }}" >> ./envfile

    - name: Copy files to server
      run: |
        scp -i ~/.ssh/id_rsa docker-stack.yml ${{ secrets.USER }}@${{ secrets.HOST }}:~/
        scp -i ~/.ssh/id_rsa envfile ${{ secrets.USER }}@${{ secrets.HOST }}:~/envfile

    - name: Deploy Docker Stack
      run: |
        ssh -i ~/.ssh/id_rsa ${{ secrets.USER }}@${{ secrets.HOST }} << 'EOF'
          # Load environment variables
          export $(cat ~/envfile | xargs)
          
          # Deploy the stack
          docker stack deploy -c ~/docker-stack.yml --with-registry-auth nextjs-pipeline
          
          # Clean up
          rm ~/docker-stack.yml ~/envfile
        EOF
